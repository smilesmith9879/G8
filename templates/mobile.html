<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>AI Smart Car - Mobile</title>
    <link rel="apple-touch-icon" href="{{ url_for('static', filename='img/app-icon.png') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/all.min.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <script src="{{ url_for('static', filename='js/socket.io.min.js') }}"></script>
    <script src="{{ url_for('static', filename='js/nipplejs.min.js') }}"></script>
    <!-- Three.js for 3D visualization -->
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/controls/OrbitControls.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #000;
            color: #fff;
            overflow: hidden;
            position: fixed;
            width: 100%;
            height: 100%;
            touch-action: none;
        }
        
        .container {
            display: flex;
            flex-direction: column;
            height: 100%;
            width: 100%;
            position: relative;
        }
        
        header {
            padding: 10px;
            background-color: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            z-index: 100;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        h1 {
            font-size: 18px;
            font-weight: 600;
        }
        
        .status-indicators {
            display: flex;
            gap: 10px;
        }
        
        .status-item {
            font-size: 12px;
            display: flex;
            align-items: center;
        }
        
        .status-ok {
            color: #4cd964;
        }
        
        .status-error {
            color: #ff3b30;
        }
        
        .video-container {
            flex: 1;
            position: relative;
            overflow: hidden;
            background-color: #111;
        }
        
        #video-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        
        .video-placeholder {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: #666;
            font-size: 14px;
        }
        
        .video-placeholder i {
            font-size: 40px;
            margin-bottom: 10px;
        }
        
        .controls-container {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            background: linear-gradient(to top, rgba(0,0,0,0.8) 0%, rgba(0,0,0,0) 100%);
        }
        
        .joystick-row {
            display: flex;
            justify-content: space-between;
            width: 100%;
        }
        
        .joystick-container {
            width: 120px;
            height: 120px;
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            position: relative;
        }
        
        .joystick-label {
            position: absolute;
            top: -25px;
            width: 100%;
            text-align: center;
            font-size: 14px;
            color: rgba(255, 255, 255, 0.7);
        }
        
        .button-row {
            display: flex;
            justify-content: center;
            gap: 20px;
        }
        
        .btn {
            padding: 10px 20px;
            border-radius: 20px;
            border: none;
            font-size: 14px;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            color: white;
        }
        
        .btn i {
            font-size: 16px;
        }
        
        .btn-primary {
            background-color: #007aff;
        }
        
        .btn-danger {
            background-color: #ff3b30;
        }
        
        .btn:disabled {
            opacity: 0.5;
        }
        
        .sensor-data {
            position: absolute;
            top: 60px;
            right: 10px;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            border-radius: 10px;
            padding: 10px;
            font-size: 12px;
            z-index: 90;
            max-width: 120px;
        }
        
        .data-group {
            margin-bottom: 8px;
        }
        
        .data-group h3 {
            font-size: 12px;
            margin-bottom: 3px;
            color: rgba(255, 255, 255, 0.7);
        }
        
        .data-item {
            margin-bottom: 2px;
        }
        
        .position-info {
            position: absolute;
            bottom: 200px;
            left: 10px;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            border-radius: 10px;
            padding: 10px;
            font-size: 12px;
            z-index: 90;
        }
        
        .diagnostic-panel {
            position: absolute;
            top: 60px;
            left: 10px;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            border-radius: 10px;
            padding: 10px;
            font-size: 12px;
            z-index: 90;
            max-width: 120px;
            transition: opacity 0.3s ease, transform 0.3s ease;
        }
        
        .diagnostic-panel.hidden {
            opacity: 0;
            transform: translateX(-120%);
            pointer-events: none;
        }
        
        .diagnostic-item {
            margin-bottom: 3px;
        }
        
        .toggle-diagnostic {
            position: absolute;
            top: 60px;
            left: 10px;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            border-radius: 50%;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            border: none;
            font-size: 16px;
            z-index: 91;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        
        .toggle-diagnostic:hover {
            background-color: rgba(0, 0, 0, 0.7);
        }
        
        .toggle-diagnostic.panel-visible {
            background-color: rgba(0, 122, 255, 0.5);
        }
        
        .slam-toggle {
            position: absolute;
            top: 60px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            border-radius: 20px;
            padding: 5px 15px;
            font-size: 14px;
            z-index: 90;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .slam-toggle i {
            font-size: 16px;
        }
        
        .slam-active {
            color: #4cd964;
        }
        
        .slam-inactive {
            color: #ff3b30;
        }
        
        #map-display {
            position: absolute;
            top: 100px;
            left: 0;
            right: 0;
            bottom: 200px;
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 80;
            pointer-events: none;
        }
        
        #map-image {
            max-width: 80%;
            max-height: 80%;
            opacity: 0.7;
        }
        
        #map3d-display {
            position: absolute;
            top: 100px;
            left: 0;
            right: 0;
            bottom: 200px;
            display: none;
            z-index: 80;
            background-color: rgba(0, 0, 0, 0.2);
        }
        
        #map3d-container {
            width: 100%;
            height: 100%;
        }
        
        .map-view-toggle {
            position: absolute;
            top: 110px;
            left: 10px;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            border-radius: 50%;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            border: none;
            font-size: 16px;
            z-index: 91;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        
        .map-view-toggle:hover {
            background-color: rgba(0, 0, 0, 0.7);
        }
        
        .fullscreen-toggle {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            color: white;
            font-size: 20px;
            z-index: 110;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>AI Smart Car</h1>
            <div class="status-indicators">
                <div class="status-item" id="robot-status">
                    {% if robot_available %}
                    <i class="fas fa-check-circle status-ok"></i>
                    {% else %}
                    <i class="fas fa-times-circle status-error"></i>
                    {% endif %}
                </div>
                <div class="status-item" id="camera-status">
                    {% if camera_available %}
                    <i class="fas fa-video status-ok"></i>
                    {% else %}
                    <i class="fas fa-video-slash status-error"></i>
                    {% endif %}
                </div>
                <div class="status-item" id="slam-status">
                    {% if slam_available %}
                    <i class="fas fa-map-marked-alt status-ok"></i>
                    {% else %}
                    <i class="fas fa-map-marked-alt status-error"></i>
                    {% endif %}
                </div>
            </div>
        </header>

        <div class="video-container">
            <div class="video-placeholder">
                <i class="fas fa-video"></i>
                <p>Video feed will appear here</p>
            </div>
            <img id="video-stream" src="{{ url_for('video_feed') }}" alt="Video Stream">
            <div id="loading-indicator">
                <div class="spinner"></div>
                <div>Connecting...</div>
            </div>
            <button class="fullscreen-toggle" onclick="toggleFullscreen()">
                <i class="fa fa-expand"></i>
            </button>
            <button class="map-view-toggle" onclick="toggleMapView()">
                <i class="fa fa-map"></i>
            </button>
            <div id="map-display">
                <img id="map-image" src="/static/map.png" alt="Map">
            </div>
            <div id="map3d-display">
                <div id="map3d-container"></div>
            </div>
        </div>

        <div class="slam-toggle" id="slam-toggle">
            <i class="fas fa-map-marked-alt slam-inactive"></i>
            <span>SLAM</span>
        </div>

        <div class="sensor-data">
            <div class="data-group">
                <h3>Accel</h3>
                <div class="data-item">X: <span id="accel-x">0.00</span></div>
                <div class="data-item">Y: <span id="accel-y">0.00</span></div>
                <div class="data-item">Z: <span id="accel-z">0.00</span></div>
            </div>
            <div class="data-group">
                <h3>Gyro</h3>
                <div class="data-item">X: <span id="gyro-x">0.00</span></div>
                <div class="data-item">Y: <span id="gyro-y">0.00</span></div>
                <div class="data-item">Z: <span id="gyro-z">0.00</span></div>
            </div>
        </div>

        <button class="toggle-diagnostic" id="toggle-diagnostic">
            <i class="fas fa-chart-bar"></i>
        </button>

        <div class="diagnostic-panel" id="diagnostic-panel">
            <div class="diagnostic-item">FPS: <span id="fps">0</span></div>
            <div class="diagnostic-item">Latency: <span id="latency">0</span>ms</div>
            <div class="diagnostic-item">CPU: <span id="cpu-usage">0</span>%</div>
            <div class="diagnostic-item">Mem: <span id="mem-usage">0</span>%</div>
        </div>

        <div class="controls-container">
            <div class="joystick-row">
                <div class="joystick-container">
                    <div class="joystick-label">Drive</div>
                    <div id="car-joystick"></div>
                </div>
                <div class="joystick-container">
                    <div class="joystick-label">Camera</div>
                    <div id="camera-joystick"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 移动端专用JavaScript
        document.addEventListener('DOMContentLoaded', function() {
            // 禁用页面滚动和缩放
            document.addEventListener('touchmove', function(e) {
                if (e.touches.length > 1) {
                    e.preventDefault();
                }
            }, { passive: false });
            
            // 禁用双击缩放
            let lastTouchEnd = 0;
            document.addEventListener('touchend', function(e) {
                const now = Date.now();
                if (now - lastTouchEnd < 300) {
                    e.preventDefault();
                }
                lastTouchEnd = now;
            }, { passive: false });
            
            // 全屏切换
            const fullscreenToggle = document.getElementById('fullscreen-toggle');
            fullscreenToggle.addEventListener('click', function() {
                if (!document.fullscreenElement) {
                    document.documentElement.requestFullscreen().catch(err => {
                        console.error(`Error attempting to enable full-screen mode: ${err.message}`);
                    });
                } else {
                    if (document.exitFullscreen) {
                        document.exitFullscreen();
                    }
                }
            });
            
            // 资源监控面板切换
            const toggleDiagnostic = document.getElementById('toggle-diagnostic');
            const diagnosticPanel = document.getElementById('diagnostic-panel');
            
            // 从本地存储中获取面板状态
            const isPanelVisible = localStorage.getItem('diagnosticPanelVisible') !== 'false';
            
            // 初始化面板状态
            if (!isPanelVisible) {
                diagnosticPanel.classList.add('hidden');
                toggleDiagnostic.classList.remove('panel-visible');
            } else {
                toggleDiagnostic.classList.add('panel-visible');
            }
            
            // 添加切换事件
            toggleDiagnostic.addEventListener('click', function() {
                diagnosticPanel.classList.toggle('hidden');
                toggleDiagnostic.classList.toggle('panel-visible');
                
                // 保存状态到本地存储
                localStorage.setItem('diagnosticPanelVisible', !diagnosticPanel.classList.contains('hidden'));
            });
            
            // 初始化摇杆控制
            const carJoystickOptions = {
                zone: document.getElementById('car-joystick'),
                mode: 'static',
                position: {left: '50%', top: '50%'},
                color: 'white',
                size: 100,
                lockX: false,
                lockY: false,
                restJoystick: true,
                restOpacity: 0.6
            };
            
            const cameraJoystickOptions = {
                zone: document.getElementById('camera-joystick'),
                mode: 'static',
                position: {left: '50%', top: '50%'},
                color: 'white',
                size: 100,
                lockX: false,
                lockY: false,
                restJoystick: true,
                restOpacity: 0.6
            };
            
            // 创建摇杆实例
            const carJoystick = nipplejs.create(carJoystickOptions);
            const cameraJoystick = nipplejs.create(cameraJoystickOptions);
            
            // Socket.IO连接
            const socket = io({
                reconnectionAttempts: 10,
                reconnectionDelay: 1000,
                timeout: 20000,
                pingTimeout: 60000,
                pingInterval: 25000
            });
            
            // 视频画布
            const videoCanvas = document.getElementById('video-canvas');
            const ctx = videoCanvas.getContext('2d');
            const videoPlaceholder = document.querySelector('.video-placeholder');
            
            // 调整画布大小
            function resizeCanvas() {
                const container = videoCanvas.parentElement;
                videoCanvas.width = container.clientWidth;
                videoCanvas.height = container.clientHeight;
            }
            
            window.addEventListener('resize', resizeCanvas);
            resizeCanvas();
            
            // 状态指示器
            const robotStatus = document.getElementById('robot-status');
            const cameraStatus = document.getElementById('camera-status');
            const slamStatus = document.getElementById('slam-status');
            
            // SLAM切换
            const slamToggle = document.getElementById('slam-toggle');
            let slamActive = false;
            let is3dViewActive = false;
            
            // Three.js变量
            let scene, camera, renderer, controls, pointCloud;
            
            // 初始化Three.js场景
            function initThreeJs() {
                // 创建场景
                scene = new THREE.Scene();
                scene.background = new THREE.Color(0xf0f0f0);
                
                // 创建相机
                const container = document.getElementById('map3d-container');
                camera = new THREE.PerspectiveCamera(75, container.clientWidth / container.clientHeight, 0.1, 1000);
                camera.position.set(5, 5, 5);
                camera.lookAt(0, 0, 0);
                
                // 创建渲染器
                renderer = new THREE.WebGLRenderer({ antialias: true });
                renderer.setSize(container.clientWidth, container.clientHeight);
                container.appendChild(renderer.domElement);
                
                // 创建控制器
                controls = new THREE.OrbitControls(camera, renderer.domElement);
                controls.enableDamping = true;
                controls.dampingFactor = 0.25;
                
                // 添加网格辅助
                const gridHelper = new THREE.GridHelper(10, 10);
                scene.add(gridHelper);
                
                // 添加坐标轴辅助
                const axesHelper = new THREE.AxesHelper(2);
                scene.add(axesHelper);
                
                // 添加环境光
                const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
                scene.add(ambientLight);
                
                // 添加方向光
                const directionalLight = new THREE.DirectionalLight(0xffffff, 0.5);
                directionalLight.position.set(5, 5, 5);
                scene.add(directionalLight);
                
                // 创建空点云
                createEmptyPointCloud();
                
                // 开始动画循环
                animate();
                
                // 处理窗口大小变化
                window.addEventListener('resize', onWindowResize);
            }
            
            // 创建空点云
            function createEmptyPointCloud() {
                const geometry = new THREE.BufferGeometry();
                const material = new THREE.PointsMaterial({
                    size: 0.05,
                    vertexColors: true
                });
                
                // 创建空缓冲区
                const positions = new Float32Array(0);
                const colors = new Float32Array(0);
                
                geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
                geometry.setAttribute('color', new THREE.BufferAttribute(colors, 3));
                
                // 创建点云
                pointCloud = new THREE.Points(geometry, material);
                scene.add(pointCloud);
            }
            
            // 更新点云数据
            function updatePointCloud(data) {
                if (!data || !data.positions || !data.colors || data.count === 0) {
                    return;
                }
                
                // 创建几何体
                const geometry = new THREE.BufferGeometry();
                
                // 创建位置和颜色数组
                const positions = new Float32Array(data.positions);
                const colors = new Float32Array(data.colors);
                
                // 设置属性
                geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
                geometry.setAttribute('color', new THREE.BufferAttribute(colors, 3));
                
                // 移除旧点云
                scene.remove(pointCloud);
                
                // 创建新点云
                const material = new THREE.PointsMaterial({
                    size: 0.05,
                    vertexColors: true
                });
                
                pointCloud = new THREE.Points(geometry, material);
                scene.add(pointCloud);
            }
            
            // 动画循环
            function animate() {
                requestAnimationFrame(animate);
                
                // 更新控制器
                if (controls) {
                    controls.update();
                }
                
                // 渲染场景
                if (renderer && scene && camera) {
                    renderer.render(scene, camera);
                }
            }
            
            // 处理窗口大小变化
            function onWindowResize() {
                const container = document.getElementById('map3d-container');
                if (camera && renderer && container) {
                    camera.aspect = container.clientWidth / container.clientHeight;
                    camera.updateProjectionMatrix();
                    renderer.setSize(container.clientWidth, container.clientHeight);
                }
            }
            
            // 切换2D和3D地图视图
            function toggleMapView() {
                is3dViewActive = !is3dViewActive;
                
                const mapDisplay = document.getElementById('map-display');
                const map3dDisplay = document.getElementById('map3d-display');
                const mapViewToggle = document.getElementById('map-view-toggle');
                
                if (is3dViewActive) {
                    // 切换到3D视图
                    mapDisplay.style.display = 'none';
                    map3dDisplay.style.display = 'block';
                    
                    // 初始化Three.js（如果尚未初始化）
                    if (!scene) {
                        initThreeJs();
                    }
                    
                    // 更新按钮图标
                    mapViewToggle.innerHTML = '<i class="fas fa-map"></i>';
                } else {
                    // 切换到2D视图
                    mapDisplay.style.display = 'flex';
                    map3dDisplay.style.display = 'none';
                    
                    // 更新按钮图标
                    mapViewToggle.innerHTML = '<i class="fas fa-cube"></i>';
                }
            }
            
            // 添加SLAM切换事件监听器
            slamToggle.addEventListener('click', function() {
                if (slamActive) {
                    socket.emit('stop_slam');
                } else {
                    socket.emit('start_slam');
                }
            });
            
            // 添加地图视图切换事件监听器
            document.getElementById('map-view-toggle').addEventListener('click', toggleMapView);
            
            // 小车控制
            let carData = { x: 0, y: 0, client_type: 'mobile' };
            
            carJoystick.on('move', function(evt, data) {
                const angle = data.angle.radian;
                const force = Math.min(1, data.force);
                
                // 计算x和y分量
                carData.x = Math.cos(angle) * force;
                carData.y = Math.sin(angle) * force;
                
                // 发送控制命令
                socket.emit('car_control', carData);
            });
            
            carJoystick.on('end', function() {
                // 停止小车
                carData = { x: 0, y: 0, client_type: 'mobile' };
                socket.emit('car_control', carData);
            });
            
            // 相机控制
            let cameraData = { x: 0, y: 0, client_type: 'mobile' };
            
            cameraJoystick.on('move', function(evt, data) {
                const angle = data.angle.radian;
                const force = Math.min(1, data.force);
                
                // 计算x和y分量
                cameraData.x = Math.cos(angle) * force;
                cameraData.y = Math.sin(angle) * force;
                
                // 发送控制命令
                socket.emit('gimbal_control', cameraData);
            });
            
            cameraJoystick.on('end', function() {
                // 停止云台
                cameraData = { x: 0, y: 0, client_type: 'mobile' };
                socket.emit('gimbal_control', cameraData);
            });
            
            // 添加Socket.IO事件处理程序
            
            // 连接事件
            socket.on('connect', function() {
                console.log('已连接到服务器');
                document.getElementById('connection-status').classList.remove('disconnected');
                document.getElementById('connection-status').classList.add('connected');
                
                // 请求初始状态
                socket.emit('get_status');
            });
            
            // 断开连接事件
            socket.on('disconnect', function() {
                console.log('与服务器断开连接');
                document.getElementById('connection-status').classList.remove('connected');
                document.getElementById('connection-status').classList.add('disconnected');
            });
            
            // 状态更新事件
            socket.on('status_update', function(data) {
                // 更新机器人状态
                updateRobotStatus(data.robot_available);
                
                // 更新相机状态
                updateCameraStatus(data.camera_available);
                
                // 更新SLAM状态
                updateSlamStatus(data.slam_available, data.slam_active);
            });
            
            // 资源使用情况更新
            socket.on('resource_usage', function(data) {
                document.getElementById('cpu-usage').textContent = data.cpu;
                document.getElementById('mem-usage').textContent = data.memory;
            });
            
            // MPU6050数据更新
            socket.on('mpu6050_data', function(data) {
                // 如果需要，可以在这里更新MPU6050数据显示
            });
            
            // SLAM状态更新
            socket.on('slam_status', function(data) {
                updateSlamStatus(data.initialized, data.active);
            });
            
            // 地图更新
            socket.on('map_update', function(data) {
                if (data.image) {
                    document.getElementById('map-image').src = 'data:image/png;base64,' + data.image;
                }
            });
            
            // 状态更新函数
            function updateRobotStatus(available) {
                const status = document.getElementById('robot-status');
                if (available) {
                    status.classList.remove('inactive');
                    status.classList.add('active');
                } else {
                    status.classList.remove('active');
                    status.classList.add('inactive');
                }
            }
            
            function updateCameraStatus(available) {
                const status = document.getElementById('camera-status');
                if (available) {
                    status.classList.remove('inactive');
                    status.classList.add('active');
                } else {
                    status.classList.remove('active');
                    status.classList.add('inactive');
                }
            }
            
            function updateSlamStatus(available, active) {
                const status = document.getElementById('slam-status');
                if (active) {
                    status.classList.remove('inactive');
                    status.classList.add('active');
                } else if (available) {
                    status.classList.remove('active');
                    status.classList.remove('inactive');
                    status.classList.add('standby');
                } else {
                    status.classList.remove('active');
                    status.classList.remove('standby');
                    status.classList.add('inactive');
                }
            }
        });

        // Map view management
        let isMapVisible = false;
        let is3DMapVisible = false;
        
        function toggleMapView() {
            if (!isMapVisible && !is3DMapVisible) {
                // Show 2D map
                document.getElementById('map-display').style.display = 'flex';
                isMapVisible = true;
            } else if (isMapVisible) {
                // Switch to 3D map if available
                document.getElementById('map-display').style.display = 'none';
                isMapVisible = false;
                
                if (window.init3DMap) {
                    document.getElementById('map3d-display').style.display = 'block';
                    is3DMapVisible = true;
                    
                    if (!window.map3dInitialized && window.init3DMap) {
                        window.init3DMap();
                        window.map3dInitialized = true;
                    }
                }
            } else {
                // Hide all maps
                document.getElementById('map3d-display').style.display = 'none';
                is3DMapVisible = false;
            }
        }
        
        // Fullscreen toggle
        function toggleFullscreen() {
            const videoContainer = document.getElementById('video-container');
            const icon = document.querySelector('.fullscreen-toggle i');
            
            if (!document.fullscreenElement) {
                if (videoContainer.requestFullscreen) {
                    videoContainer.requestFullscreen();
                } else if (videoContainer.webkitRequestFullscreen) {
                    videoContainer.webkitRequestFullscreen();
                } else if (videoContainer.msRequestFullscreen) {
                    videoContainer.msRequestFullscreen();
                }
                icon.classList.remove('fa-expand');
                icon.classList.add('fa-compress');
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                } else if (document.webkitExitFullscreen) {
                    document.webkitExitFullscreen();
                } else if (document.msExitFullscreen) {
                    document.msExitFullscreen();
                }
                icon.classList.remove('fa-compress');
                icon.classList.add('fa-expand');
            }
        }
        
        // Listen for fullscreen change events
        document.addEventListener('fullscreenchange', updateFullscreenIcon);
        document.addEventListener('webkitfullscreenchange', updateFullscreenIcon);
        document.addEventListener('mozfullscreenchange', updateFullscreenIcon);
        document.addEventListener('MSFullscreenChange', updateFullscreenIcon);
        
        function updateFullscreenIcon() {
            const icon = document.querySelector('.fullscreen-toggle i');
            if (document.fullscreenElement) {
                icon.classList.remove('fa-expand');
                icon.classList.add('fa-compress');
            } else {
                icon.classList.remove('fa-compress');
                icon.classList.add('fa-expand');
            }
        }
    </script>
</body>
</html> 